<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Intersol Messenger - IRC Edition</title>
    <style>
        :root { --aero-blue: rgba(173, 216, 230, 0.4); --msn-blue: #0078d7; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; 
            background: #004b8d url('https://www.transparenttextures.com/patterns/cubes.png');
            display: flex; justify-content: center; align-items: center; height: 100vh; 
        }

        /* VENTANA PRINCIPAL */
        .msn-window { 
            width: 700px; height: 500px; /* M√°s ancha para el chat tipo mIRC */
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5); display: flex;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); border-radius: 5px; overflow: hidden;
        }

        /* LATERAL: LISTA DE CONTACTOS (TIPO mIRC) */
        .sidebar { 
            width: 200px; background: rgba(240, 245, 255, 0.7); 
            border-right: 1px solid #a0b4cd; display: flex; flex-direction: column;
        }
        .sidebar-header { padding: 10px; background: var(--aero-blue); font-weight: bold; font-size: 12px; border-bottom: 1px solid #a0b4cd; }
        
        .contact-list { flex-grow: 1; overflow-y: auto; padding: 5px; }
        .group-header { font-size: 10px; font-weight: bold; color: #555; padding: 8px 5px 2px 5px; }
        
        .user-item { 
            display: flex; align-items: center; padding: 4px 8px; cursor: pointer; border-radius: 3px; font-size: 12px;
        }
        .user-item:hover { background: #fff; outline: 1px solid #ffba00; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
        .online { background: #31a24c; }
        .fav-star { margin-left: auto; color: #ccc; cursor: pointer; font-size: 14px; }
        .fav-star.active { color: #ffb400; }

        /* √ÅREA DE CHAT (ESTILO mIRC/SUITE) */
        .chat-area { flex-grow: 1; display: flex; flex-direction: column; background: white; }
        .chat-header { padding: 10px 15px; background: #f0f0f0; border-bottom: 1px solid #ddd; font-size: 13px; font-weight: bold; }
        
        #chat-buffer { 
            flex-grow: 1; padding: 15px; overflow-y: auto; 
            font-family: 'Consolas', 'Courier New', monospace; font-size: 13px; line-height: 1.4;
            background: #fff; color: #333;
        }
        .msg-line { margin-bottom: 2px; }
        .msg-time { color: #888; font-size: 11px; margin-right: 5px; }
        .msg-user { font-weight: bold; color: var(--msn-blue); margin-right: 5px; }

        .chat-input-area { padding: 10px; background: #f9f9f9; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        #chat-input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; outline: none; border-radius: 3px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="msn-window">
        <div class="sidebar">
            <div class="sidebar-header">Intersol Messenger</div>
            <div class="contact-list">
                <div id="group-favs" class="hidden">
                    <div class="group-header">‚≠ê FAVORITOS</div>
                    <div id="list-favs"></div>
                </div>
                <div class="group-header">üë• AMIGOS</div>
                <div id="list-friends"></div>
            </div>
            <div style="padding:10px; border-top:1px solid #a0b4cd; font-size: 11px; text-align:center;">
                <a href="hotmail.html" style="color:var(--msn-blue); text-decoration:none;">üìß Ir al Correo</a>
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header">Sala Principal: #Intersol_Global</div>
            <div id="chat-buffer">
                <div class="msg-line" style="color: green;">* Conectando al servidor Intersol...</div>
                <div class="msg-line" style="color: green;">* Sesi√≥n iniciada como <span id="my-name-display"></span></div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Escribe un mensaje..." onkeypress="handleKey(event)">
                <button onclick="enviarMensaje()" style="background:var(--msn-blue); color:white; border:none; padding:0 15px; border-radius:3px; cursor:pointer;">Enviar</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyAWMmRpC9chHuBMWbMCRFeEzhQjh1dJ0Uw", databaseURL: "https://intersol-ce061-default-rtdb.firebaseio.com" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const session = JSON.parse(localStorage.getItem('intersol_user'));
    if(!session) window.location.href = "hotmail.html";

    const myNick = session.email.split('@')[0];
    document.getElementById('my-name-display').innerText = myNick;

    // --- L√ìGICA DE CONTACTOS Y FAVORITOS ---
    onValue(ref(db, 'intersol/usuarios'), (snap) => {
        const listFavs = document.getElementById('list-favs');
        const listFriends = document.getElementById('list-friends');
        const favs = JSON.parse(localStorage.getItem('intersol_favs')) || [];
        
        listFavs.innerHTML = ""; listFriends.innerHTML = "";
        let hasFavs = false;

        snap.forEach(child => {
            const user = child.val();
            if(user.email === session.email) return;

            const isFav = favs.includes(user.email);
            if(isFav) hasFavs = true;

            const div = document.createElement('div');
            div.className = 'user-item';
            div.innerHTML = `
                <div class="status-dot online"></div>
                <span>${user.email.split('@')[0]}</span>
                <span class="fav-star ${isFav ? 'active' : ''}">‚òÖ</span>
            `;

            div.querySelector('.fav-star').onclick = (e) => {
                e.stopPropagation();
                toggleFav(user.email);
            };

            if(isFav) listFavs.appendChild(div);
            else listFriends.appendChild(div);
        });
        document.getElementById('group-favs').classList.toggle('hidden', !hasFavs);
    });

    function toggleFav(email) {
        let favs = JSON.parse(localStorage.getItem('intersol_favs')) || [];
        favs = favs.includes(email) ? favs.filter(e => e !== email) : [...favs, email];
        localStorage.setItem('intersol_favs', JSON.stringify(favs));
    }

    // --- L√ìGICA DE CHAT GRUPAL (TIPO mIRC) ---
    const chatBuffer = document.getElementById('chat-buffer');

    window.enviarMensaje = () => {
        const input = document.getElementById('chat-input');
        if(!input.value.trim()) return;

        push(ref(db, 'intersol/msn_global'), {
            user: myNick,
            text: input.value,
            time: serverTimestamp()
        });
        input.value = "";
    };

    window.handleKey = (e) => { if(e.key === 'Enter') enviarMensaje(); };

    onValue(ref(db, 'intersol/msn_global'), (snap) => {
        chatBuffer.innerHTML = ""; // En mIRC se suele ver el historial reciente
        snap.forEach(child => {
            const msg = child.val();
            const timeStr = msg.time ? new Date(msg.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "";
            
            const div = document.createElement('div');
            div.className = 'msg-line';
            div.innerHTML = `<span class="msg-time">[${timeStr}]</span><span class="msg-user">&lt;${msg.user}&gt;</span><span class="msg-text">${msg.text}</span>`;
            chatBuffer.appendChild(div);
        });
        chatBuffer.scrollTop = chatBuffer.scrollHeight;
    });
</script>
</body>
</html>
